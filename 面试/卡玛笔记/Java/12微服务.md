# 微服务

## 什么是服务熔断、服务降级

在复杂的分布式系统中，微服务之间的相互调用，有可能出现各种各样的原因导致服务的阻塞，在 高并发场景下，服务的阻塞意味着线程的阻塞，导致当前线程不可用，服务器的线程全部阻塞，导 致服务器崩溃，由于服务之间的调用关系是同步的，会对整个微服务系统造成服务雪崩

![image-20240116155715439](https://gitee.com/CHENKAIforyou/image-bed/raw/master/imag/image-20240116155715439.png)

为了解决某个微服务的调用响应时间过长或者不可用进而占用越来越多的系统资源引起雪崩效应就 需要进行服务熔断和服务降级处理。

所谓的服务熔断指的是某个服务故障或异常一起类似现实世界中的“保险丝"当某个异常条件被触发 就直接熔断整个服务，而不是一直等到此服务超时。

服务熔断就是相当于我们电闸的保险丝，一旦发生服务雪崩的，就会熔断整个服务，通过维护一个 自己的线程池，当线程达到阈值的时候就启动服务降级，如果其他请求继续访问就直接返回 fallback的默认值

## Eureka和ZooKeeper都可以提供服务注册与发现的功 能，请说说两个的区别

- ZooKeeper保证的是CP，Eureka保证的是AP
- ZooKeeper在选举期间注册服务瘫痪，虽然服务最终会恢复，但是选举期间不可用的
- Eureka各个节点是平等关系，只要有一台Eureka就可以保证服务可用，而查询到的数据并不是最 新的
- 自我保护机制会导致Eureka不再从注册列表移除因长时间没收到心跳而应该过期的服务
- Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点(高可用)
- 当网络稳定时，当前实例新的注册信息会被同步到其他节点中(最终一致性)
- Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像ZooKeeper一样使得 整个注册系统瘫痪
- ZooKeeper有Leader和Follower角色，Eureka各个节点平等
- ZooKeeper采用过半数存活原则，Eureka采用自我保护机制解决分区问题
- Eureka本质上是一个工程，而ZooKeeper只是一个进程

## 负载均衡策略

- 使用负载均衡带来的好处很明显:
  - 当集群里的1台或者多台服务器down的时候，剩余的没有down的服务器可以保证服务的继 续使用
  - 使用了更多的机器保证了机器的良性使用，不会由于某一高峰时刻导致系统cpu急剧上升

负载均衡有好几种实现策略，常见的有:

- 随机 (Random)
- 轮询 (RoundRobin)
- 哈希 (Hash)
  - ip信息%机器数量
- 一致性哈希 (ConsistentHash)
  - 服务器ip信息 % 2的32次方-1 的结果落在哈希环上，顺时针取最近的

## Ribbon内置的负载均衡策略

![image-20240116160150861](https://file1.kamacoder.com/i/bagu/image-20240116160150861.png)